<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
		<title>Insert title here</title>
		<style type="text/css">
		body {
			background-color:#e0e0e0;
		}
		
		</style>
		<script src="../js/lib/jquery-2.0.2.js"></script>
		<script src="../js/lib/three.min.js"></script>
		<script src="../js/controls/TrackballControls.js"></script>
		<script src="../js/rcSphere.js"></script>
		<script src="../js/lib/hammer.js"></script>
		<script src="../js/lib/plugins/hammer.fakemultitouch.js"></script>
		<script src="../js/lib/plugins/hammer.showtouches.js"></script>
		<script type="text/javascript">
		 $(document).ready(function() {
			 init();
			 $(window).bind('beforeunload', function(){
			     //save info somewhere
				console.log("beforeunload");
			    uninit();
			    return 'are you sure you want to leave?';
			});
		});
		 
		 function uninit() {
			 
		 }
		 
		 
			var canvas;
			
			var virtualKey;
						
			function init() {
			
				Hammer.plugins.fakeMultitouch();
			    var properties = ['gesture','center','deltaTime','angle','direction',
			                      'distance','deltaX','deltaY','velocityX','velocityY', 'pointerType',
			                      'scale','rotation','touches','target'];
			    
			    
			    var all_events = [];
			    
			    /*
			    $("#events-list li").each(function() {
			        var li = $(this);
			        var type = li.text();
			        li.attr("id", "log-gesture-"+type);
			        all_events.push(type);
			    });
			    ) */
			    for(var i = 0, l = properties.length; i < l ; i++) {
			    	all_events.push(properties[i]);
			    }

			    var hammertime = Hammer(document.getElementById('virtualKey'), {
		            prevent_default: true,
		            no_mouseevents: true
		        })
		        .on(all_events.join(" "), function(e0) {
		        	console.log(e0);
					event.preventDefault();
				   	console.log("Scale: " + event.scale + ", Rotation: " + event.scale);
					var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gesturechange", "scale": event.scale, "rotation": event.scale}, "id": 1}
					$.doSend(object);
		        });
			    
			    
			    
				canvas = document.getElementById("canvas");
				canvas.style.display = "none";
				
				virtualKey = document.getElementById("virtualKey");
			
				$.bind();
				
				<!-- keyboard event -->
				
				virtualKey.addEventListener('touchstart', function(event) {
					event.preventDefault();
					this.focus();
				}, false);
				
				virtualKey.addEventListener('change', function(event) {
					event.preventDefault();
					var data = virtualKey.value;
					var object = {"jsonrpc": "2.0", "method": "echo", "params": data, "id": 1}
					$.doSend(object);
				}, false);
				
				
				
				<!-- touch event -->
				canvas.addEventListener('touchstart', function(event) {
					event.preventDefault();
					var touch = event.touches[0];
					switch ( event.touches.length ) {
					case 1:
						console.log("Touch x:" + touch.pageX + ", y:" + touch.pageY);
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"touchstart", "x": touch.pageX, "y": touch.pageY}, "id": 1}
					   	$.doSend(object);
						break;

					case 2: {
						console.log("Touch x:" + touch.pageX + ", y:" + touch.pageY);
						var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
						var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
						var scale = Math.sqrt( dx * dx + dy * dy );
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gesturestart", "scale": (scale*100), "rotation": event.rotation}, "id": 1}
						$.doSend(object);
						x0 = event.touches[ 1 ].pageX;
						y0 = event.touches[ 1 ].pageY;
						break;
					}

					case 3:
						console.log("pan?");
						break;

					default:
						console.log("no idea");
						break;
					}

					}, false);
						
				canvas.addEventListener('touchmove', function(event) {
					event.preventDefault();
					var touch = event.touches[0];
					switch ( event.touches.length ) {
					case 1: {
						console.log("Touch x:" + touch.pageX + ", y:" + touch.pageY);
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"touchmove", "x": touch.pageX, "y": touch.pageY}, "id": 1}
						$.doSend(object);
						break;
					}
					case 2: {
						//var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
						//var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
						//var scale = Math.sqrt( dx * dx + dy * dy );
					   	//console.log("Scale: " + scale + ", Rotation: " + event.rotation);
					   	var x = (event.touches[ 1 ].pageX > event.touches[ 0 ].pageX) ? event.touches[ 1 ].pageX : event.touches[ 0 ].pageX; 
					   	var dx = x - x0;
					   	var scale = dx;
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gesturechange", "scale": scale, "rotation": 0}, "id": 1}
						$.doSend(object);
						x0 = event.touches[ 1 ].pageX;
						y0 = event.touches[ 1 ].pageY;
						break;
					}
					case 3:
						console.log("pan?");
						break;
					default:
						console.log("no idea");
						break;
					}
					
					}, false);
				
				canvas.addEventListener('touchend', function(event) {
					event.preventDefault();
					switch ( event.touches.length ) {
					case 0: {
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"touchend", "x": 0, "y": 0}, "id": 1}
						$.doSend(object);
						break;
					}
					case 1: { // gesture end
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gestureend", "scale": 0, "rotation": 0}, "id": 1}
						$.doSend(object);
						break;
					}
					case 2: {
					   	//console.log("Scale: " + event.scale + ", Rotation: " + event.scale);
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gestureend2", "scale": 0, "rotation": 0}, "id": 1}
						$.doSend(object);
						break;
					}
					case 3: { 
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gestureend3", "scale": 0, "rotation": 0}, "id": 1}
						$.doSend(object);
						break;
					}
					case 4:
						break;
						
					default:
						var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gestureendd", "scale": 0, "rotation": 0}, "id": 1}
						$.doSend(object);
						break;
					
					}
					
					//var touch = event.touches[0];
					//console.log("Touch x:" + touch.pageX + ", y:" + touch.pageY);
					}, false);
				<!-- touch event -->
				
				
				/*
				<!-- gesture event -->
				canvas.addEventListener('gesturestart', function(event) {
					event.preventDefault();
					console.log("Scale: " + event.scale + ", Rotation: " + event.scale);
					var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gesturestart", "scale": event.scale, "rotation": event.scale}, "id": 1}
					$.doSend(object);
					}, false);
				
				canvas.addEventListener('gesturechange', function(event) {
					event.preventDefault();
				   	console.log("Scale: " + event.scale + ", Rotation: " + event.scale);
					var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gesturechange", "scale": event.scale, "rotation": event.scale}, "id": 1}
					$.doSend(object);
					}, false);
				
				canvas.addEventListener('gestureend', function(event) {
				  	event.preventDefault();
				   	console.log("Scale: " + event.scale + ", Rotation: " + event.scale);
					var object = {"jsonrpc": "2.0", "method": "remotecontroller:event", "params": {"event":"gestureend", "scale": event.scale, "rotation": event.scale}, "id": 1}
					$.doSend(object);
					}, false);
				<!-- gesture event -->
				*/
			}
			
			$.get_appropriate_ws_url = function (){
				var pcol;
				var u = document.URL;
				if (u.substring(0, 5) == "https") {
					pcol = "wss://";
					u = u.substr(8);
				} else {
					pcol = "ws://";
					if (u.substring(0, 4) == "http")
						u = u.substr(7);
				}
				u = u.split('/');
			   	u[0] = u[0] + "/BAM";
				return pcol + u[0];
			}
			
			$.bind = function() {
				//const uri = "ws://192.168.0.27:8080";
				//websocket = new WebSocket(uri);
				websocket = new WebSocket($.get_appropriate_ws_url());
				//websocket.binaryType = "arraybuffer";
				websocket.onopen = function(evt) {
					$.connectionOn();
				};
				websocket.onclose = function(evt) {
					$.connectionOff();
				};
				websocket.onmessage = function(evt) {
		
				};
				websocket.onerror = function(evt) {
				
				};
			}
			
			$.doSend = function(message) {
				
				var object = JSON.stringify(message);
				websocket.send(object);
			}
			
			$.connectionOn = function() {
				
				document.getElementById("canvas").style.display = "block";
				renderInit();
				animate();
			}
			
			$.connectionOff = function() {
				
				document.getElementById("canvas").style.display = "none";
			}
		
			//window.addEventListener("load", init, false);
			
		</script>
	</head>
	<body >
		<div align="center">
			<div id="canvas"></div>
			<input id="virtualKey" size="20" type="text" style="height:30px"/>
		</div>
		
	</body>
</html>