<!DOCTYPE html>
<html lang="en">
<head>
 <!--meta charset=utf-8 /-->
<meta charset="utf-8" />
 <title>TEST</title>
 
 <script type="text/javascript" src="js/lib/jquery-2.0.2.js"></script>
 <script type="text/javascript" src="js/lib/class.js"></script>
 <script type="text/javascript" src="js/lib/three.min.js"></script>
 <script type="text/javascript" src="js/K.js"></script>
 <script type="text/javascript">
	 $("head").append("<link>");
	 var css = $("head").children(":last");
	 css.attr({
	       rel:  "stylesheet",
	       type: "text/css",
	       href: "skins/default/periodictable.css"
	 });


		
	 $(document).ready(function() {
		 init3();
		 animate();
		 
		 K.addEventListener(systemEventListener);
		const uri = "ws://192.168.1.36:8080";
		//const uri = "ws://192.168.0.27:8080";
		//const uri = K.getWebSocketURL();
		console.log(uri);
		
		K.bind(uri);
		K.createControl();
		 $(window).bind('beforeunload', function(){
		     //save info somewhere
			console.log("beforeunload");
		    K.uninit();
		    return 'are you sure you want to leave?';
		});
	});

		var camera, scene, renderer;
		var controls;
		var objects = [];
		var helix = [];
		var i = 0;
		
	 function init3() {
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 5000 );
			camera.position.z = 1800;
			
			scene = new THREE.Scene();
			
			renderer = new THREE.CSS3DRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.domElement.style.position = 'absolute';
			document.getElementById( 'container' ).appendChild( renderer.domElement );
			
			
			controls = new THREE.TrackballControls( camera, renderer.domElement );
			controls.rotateSpeed = 0.5;
			controls.addEventListener( 'change', render );
			
			
			console.log("init3 : ");
			transform( helix, 2000 );
			console.log("init3 : ");
			window.addEventListener( 'resize', onWindowResize, false );
	 }

	 
		function transform( targets, duration ) {
			console.log("transform : ");
			TWEEN.removeAll();
			console.log("transform");
			for ( var i = 0; i < objects.length; i ++ ) {
				console.log("transform");
				var object = objects[ i ];
				var target = targets[ i ];
				console.log("transform");
				console.log("object position: " + object.position);
				new TWEEN.Tween( object.position )
					.to( { x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration )
					.easing( TWEEN.Easing.Exponential.InOut )
					.start();
				console.log("transform");
				new TWEEN.Tween( object.rotation )
					.to( { x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration )
					.easing( TWEEN.Easing.Exponential.InOut )
					.start();
				console.log("transform");
			}
			console.log("transform");
			new TWEEN.Tween( this )
				.to( {}, duration * 2 )
				.onUpdate( render )
				.start();
			console.log("transform");
		}
	
		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function animate() {

			requestAnimationFrame( animate );

			TWEEN.update();
			controls.update();

		}

		function render() {

			renderer.render( scene, camera );

		}
		
		function createObject(name) {
			var item = helix[i] = [name, "Hydrogen", "1.00794", 1, 1];
			console.log("createObject : " + name);
			var element = document.createElement( 'div' );
			element.className = 'element';
			element.style.backgroundColor = 'rgba(0,127,127,' + ( Math.random() * 0.5 + 0.25 ) + ')';
			var number = document.createElement( 'div' );
			number.className = 'number';
			number.textContent = i + 1;
			element.appendChild( number );

			var symbol = document.createElement( 'div' );
			symbol.className = 'symbol';
			symbol.textContent = item[ 0 ];
			element.appendChild( symbol );

			var details = document.createElement( 'div' );
			details.className = 'details';
			details.innerHTML = item[ 1 ] + '<br>' + item[ 2 ];
			element.appendChild( details );

			var object = new THREE.CSS3DObject( element );
			object.position.x = Math.random() * 4000 - 2000;
			object.position.y = Math.random() * 4000 - 2000;
			object.position.z = Math.random() * 4000 - 2000;
			scene.add( object );
			objects.push( object );
			
			var vector = new THREE.Vector3();

			for ( var i = 0, l = objects.length; i < l; i ++ ) {

				var phi = i * 0.175 + Math.PI;

				var object = new THREE.Object3D();

				object.position.x = 1100 * Math.sin( phi );
				object.position.y = - ( i * 8 ) + 450;
				object.position.z = 1100 * Math.cos( phi );

				vector.copy( object.position );
				vector.x *= 2;
				vector.z *= 2;

				object.lookAt( vector );
				helix.push( object );
			}
			
			
			console.log("createObject : DONE!!!!" + name);
			helix.push(object);
			console.log("createObject : DONE!!!!" + name);
			transform( helix, 5000 );
			console.log("createObject : DONE!!!!" + name);
		}
	 
	 function createDeviceButton(text, icon, uuid) {
		 var $input = $("<input>", {id: uuid, type: "image", value: text, src: icon});
		 $input.click(function() {
			 var uuid = this.id;
			 console.log(uuid);
			 K.subscribeServer(uuid);
			 K.browse('0', 0, 10);
		 });
		 $('#space') // Replace this selector with one suitable for you
		 .append($input)
	 }

	function removeDeviceButton(uuid) {
		 $('#' + uuid) // Replace this selector with one suitable for you
		.remove();
	}
	
	 function createMediaButton(text, icon, objectId) {
		 var $input = $("<input>", {id: objectId, type: "button", value: text, src: icon});
		 $input.click(function() {
			 var objectId = this.id;
			 K.browse(objectId, 0, 10);
		 });
		 $('#space') // Replace this selector with one suitable for you
		 .append($input)
	 }
	function removeDeviceButton(objectId) {
		 $('#' + objectId) // Replace this selector with one suitable for you
		.remove();
	}
	
	 function systemEventListener(e) {
		console.log(e);
		switch(e.event) {
		case 'open':  {// if you call k.bind and it success, this routine will be called.
			K.addDmsEvent();
			// K.subscribeEvent('dmsEvent''); // It looks better way to subscribe an event that you want to monitor.
			break;
		}
		case 'close':
			break;
			
		case 'dmsAdded': {
			//TODO: This is a test
			//createDeviceButton(e.friendlyName, e.icon, e.uuid);
			//K.subscribeServer(e.uuid);
			//K.browse('0', 0, 10);
			createObject(e.friendlyName);
			i++;
			break;
		}
		case 'dmsRemoved':
			//TODO:
			removeDeviceButton(e.uuid);
			i--;
			break;

		case 'dmrAdded':
			//TODO:
			break;
		
		case 'dmrRemoved':
			//TODO:
			break;
		
		case 'channelChanged':
			//TODO:
			break;
			
		case 'subscribeServer': {
			break;
		}
		case 'browse': {
			var icon = null;
			switch(e.class) {
			case 'object.container': {
				icon = "images/EPG_colorkey_blue.png";
				break;
			}
			case 'object.item.videoItem': {
				icon = "images/EPG_colorkey_red.png";
				break;
			}
			case  'object.item.audioItem.musicTrack': {
				icon = "images/EPG_colorkey_yellow.png";
				break;
			}
			case  'object.item.imageItem.photo': {
				icon = "images/EPG_colorkey_yellow.png";
				break;
			}
			default :
				alert("unknowns");
				break;
			}
			createMediaButton(e.title, icon ,e.objectId);
			break;
		}
		default:
			alert("unknown: " + e);
			break;
		}
	 }
	 
	 
 </script>
 </head>
 
 <body>
  	<script type="text/javascript" src="js/lib/three.min.js"></script>
	<script src="js/libs/tween.min.js"></script>
	<script src="js/controls/TrackballControls.js"></script>
	<script src="js/renderers/CSS3DRenderer.js"></script>

 	<div id="log">
 	</div>
 	<div id="space">
 	</div>
 	<div id="container"></div>
 </body>

